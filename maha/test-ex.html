<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Lighting Design Report PDF Export</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background: #f7f9fc; padding: 20px; }
  .card { box-shadow: 0 6px 18px rgba(18,38,63,.06); }
</style>
</head>
<body>

<div class="container">
  <h1 class="mb-3">Lighting Design â€” PDF Export with Background</h1>

  <div class="card p-3 mb-3">
    <h5>Project & Room</h5>
    <form id="calcForm" class="row g-2">
      <div class="col-md-6">
        <label class="form-label">Project Name</label>
        <input class="form-control" id="projectName" placeholder="My Project">
      </div>
      <div class="col-md-6">
        <label class="form-label">Client Name</label>
        <input class="form-control" id="clientName" placeholder="Client">
      </div>
      <div class="col-md-6">
        <label class="form-label">Client Number</label>
        <input class="form-control" id="clientNumber" placeholder="Phone">
      </div>
      <div class="col-md-6">
        <label class="form-label">Company Name</label>
        <input class="form-control" id="companyName" placeholder="Company">
      </div>
      <div class="col-12 mt-2">
        <button type="button" id="btnDownloadPdf" class="btn btn-primary">Download PDF</button>
      </div>
    </form>
  </div>

  <div class="card p-3">
    <h5>Results</h5>
    <pre id="rawJson" style="height:200px; overflow:auto;"></pre>
  </div>
</div>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
const BACKGROUND_IMG_URL = "../assets/pdfBG.png"; // Replace with your full A4 background image

// Example mock results
const mockResults = [
  { "Luminaire": "SC highbay", "Power (W)": 100, "Efficacy (lm/W)": 145, "Fixtures": 133, "Spacing X (m)": 6.94, "Spacing Y (m)": 6.94, "Average Lux": 301.33, "Uniformity": 0.5, "Total Power (W)": 13300 },
  { "Luminaire": "SC highbay", "Power (W)": 100, "Efficacy (lm/W)": 160, "Fixtures": 121, "Spacing X (m)": 7.27, "Spacing Y (m)": 7.27, "Average Lux": 302.5, "Uniformity": 0.5, "Total Power (W)": 12100 },
  { "Luminaire": "SC highbay", "Power (W)": 100, "Efficacy (lm/W)": 200, "Fixtures": 97, "Spacing X (m)": 8.12, "Spacing Y (m)": 8.12, "Average Lux": 303.12, "Uniformity": 0.5, "Total Power (W)": 9700 }
];

document.getElementById('rawJson').textContent = JSON.stringify({results: mockResults}, null, 2);

document.getElementById('btnDownloadPdf').addEventListener('click', async () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ format: 'a4', unit: 'mm' });

  // Load background image
  const bgImg = await loadImage(BACKGROUND_IMG_URL);
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  doc.addImage(bgImg, 'JPEG', 0, 0, pageWidth, pageHeight);

  // Project info
  const project_info = {
    "Project Name": document.getElementById('projectName').value || '',
    "Client Name": document.getElementById('clientName').value || '',
    "Client Number": document.getElementById('clientNumber').value || '',
    "Company Name": document.getElementById('companyName').value || ''
  };

  doc.setFontSize(14);
  let y = 40; // start position after header in background
  doc.text(`Project Name: ${project_info["Project Name"]}`, 15, y);
  doc.text(`Client Name: ${project_info["Client Name"]}`, 15, y+8);
  doc.text(`Client Number: ${project_info["Client Number"]}`, 15, y+16);
  doc.text(`Company Name: ${project_info["Company Name"]}`, 15, y+24);

  // Table
  doc.autoTable({
    startY: y+35,
    head: [Object.keys(mockResults[0])],
    body: mockResults.map(r => Object.values(r)),
    theme: 'grid',
    styles: { fontSize: 8 },
    headStyles: { fillColor: [0, 102, 204], textColor: 255 }
  });

  // Technical note at bottom left
  let finalY = doc.lastAutoTable.finalY + 10;
  doc.setFontSize(10);
  doc.text("Technical Note:", 15, finalY);
  doc.text([
    "To avoid electrical instability issues, always use drivers with built-in protections:",
    "- Over voltage protection",
    "- Over current protection"
  ], 15, finalY+6);

  doc.save((project_info["Project Name"] || 'lighting_report') + '.pdf');
});

function loadImage(url) {
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "anonymous";
    img.onload = () => resolve(img);
    img.src = url;
  });
}
</script>

</body>
</html>
