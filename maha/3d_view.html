<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Model Viewer</title>
  <style>body { margin:0; overflow:hidden; }</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.124.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.124.0/examples/js/controls/OrbitControls.js"></script>

<script>
  // قراءة البيانات من localStorage
  const dataStr = localStorage.getItem('lightingModelData');
  if (!dataStr) {
    alert('No lighting model data found in localStorage. Please calculate first.');
    throw new Error('No data');
  }
  const data = JSON.parse(dataStr);

  // إعداد المشهد والكاميرا والريندر
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xdddddd);

  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(data.roomLength, data.roomLength, data.roomLength);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // شبكة أرضية
  const gridHelper = new THREE.GridHelper(Math.max(data.roomLength, data.roomWidth)*1.5, 20);
  scene.add(gridHelper);

  // إضاءة
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);

  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
  directionalLight.position.set(10, 20, 10);
  scene.add(directionalLight);

  // دالة لإضافة fixtures (كشافات) كمكعبات صفراء
  function addFixture(x, y, z) {
    const geometry = new THREE.BoxGeometry(1, 0.5, 1);
    const material = new THREE.MeshStandardMaterial({ color: 0xffcc00 });
    const fixture = new THREE.Mesh(geometry, material);
    fixture.position.set(x, y, z);
    scene.add(fixture);
  }

  // نحسب توزيع fixtures بناءً على البيانات
  const { fixtures, spacingX, spacingY, roomLength, roomWidth } = data;

  // حساب عدد الأعمدة والصفوف
  let cols = Math.round(Math.sqrt(fixtures)) || 1;
  let rows = Math.ceil(fixtures / cols);

  if (spacingX > 0 && spacingY > 0) {
    const approxCols = Math.max(1, Math.round(roomLength / spacingX));
    const approxRows = Math.max(1, Math.round(roomWidth / spacingY));
    if (approxCols * approxRows >= fixtures) {
      cols = approxCols;
      rows = approxRows;
    }
  }

  // توزيع fixtures داخل الغرفة، ورفعها فوق الأرض (مثلاً ارتفاع 10)
  const startX = - (cols - 1) * spacingX / 2;
  const startZ = - (rows - 1) * spacingY / 2;
  for(let r = 0; r < rows; r++) {
    for(let c = 0; c < cols; c++) {
      const index = r * cols + c;
      if (index >= fixtures) break;
      const x = startX + c * spacingX;
      const y = 10; // ارتفاع الكشاف
      const z = startZ + r * spacingY;
      addFixture(x, y, z);
    }
  }

  // إعدادات التحكم بالماوس OrbitControls
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.target.set(0, 0, 0);
  controls.update();

  // حلقة الرندر
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // التكيف مع تغيير حجم النافذة
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>
</body>
</html>
