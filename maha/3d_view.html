<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Model Viewer</title>
  <style>body { margin:0; overflow:hidden; }</style>
</head>
<body>
<script src="js/three.min.js"></script>
<script src="js/OrbitControls.js"></script>

<script>
  // قراءة البيانات من localStorage
  const dataStr = localStorage.getItem('lightingModelData');
  console.log(dataStr);
  
  if (!dataStr) {
    alert('No lighting model data found in localStorage. Please calculate first.');
    throw new Error('No data');
  }
  const data = JSON.parse(dataStr);

  // إعداد المشهد والكاميرا والريندر
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xdddddd);

  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(data.roomLength, data.roomLength, data.roomLength);

  const renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  // شبكة أرضية
  const gridHelper = new THREE.GridHelper(Math.max(data.roomLength, data.roomWidth)*1.5, 20);
  scene.add(gridHelper);

  // إضاءة
  const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
  scene.add(ambientLight);

  const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
  directionalLight.position.set(10, 20, 10);
  scene.add(directionalLight);

  // دالة لإضافة fixtures (كشافات) كمكعبات صفراء
  function addFixture(x, y, z) {
  const highBay = new THREE.Group();

  // Top hook
  const hook = new THREE.Mesh(
    new THREE.TorusGeometry(0.15, 0.03, 8, 16, Math.PI),
    new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.8, roughness: 0.3 })
  );
  hook.rotation.x = Math.PI / 2;
  hook.position.y = 0.45;
  highBay.add(hook);

  // Short stem
  const stem = new THREE.Mesh(
    new THREE.CylinderGeometry(0.05, 0.05, 0.3, 16),
    new THREE.MeshStandardMaterial({ color: 0x999999, metalness: 0.7, roughness: 0.4 })
  );
  stem.position.y = 0.2;
  highBay.add(stem);

  // Dome housing (main body)
  const dome = new THREE.Mesh(
    new THREE.SphereGeometry(0.6, 32, 16, 0, Math.PI * 2, 0, Math.PI / 2),
    new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.6, roughness: 0.5 })
  );
  dome.position.y = -0.3;
  highBay.add(dome);

  // Lens at the bottom
  const lens = new THREE.Mesh(
    new THREE.CircleGeometry(0.55, 32),
    new THREE.MeshStandardMaterial({ color: 0xffffdd, emissive: 0xffffaa, emissiveIntensity: 0.6 })
  );
  lens.rotation.x = -Math.PI / 2;
  lens.position.y = -0.6;
  highBay.add(lens);

  // Light beam cone
  const beamGeometry = new THREE.ConeGeometry(2, 3, 32, 1, true);
  const beamMaterial = new THREE.MeshBasicMaterial({
    color: 0xffffaa,
    transparent: true,
    opacity: 0.15,
    side: THREE.DoubleSide
  });
  const beam = new THREE.Mesh(beamGeometry, beamMaterial);
  beam.position.y = -2.1;
  beam.rotation.x = Math.PI;
  highBay.add(beam);

  // Position the whole fixture
  highBay.position.set(x, y, z);

  scene.add(highBay);
}

  // نحسب توزيع fixtures بناءً على البيانات
  const { fixtures, spacingX, spacingY, roomLength, roomWidth } = data;

  // حساب عدد الأعمدة والصفوف
  let cols = Math.round(Math.sqrt(fixtures)) || 1;
  let rows = Math.ceil(fixtures / cols);

  if (spacingX > 0 && spacingY > 0) {
    const approxCols = Math.max(1, Math.round(roomLength / spacingX));
    const approxRows = Math.max(1, Math.round(roomWidth / spacingY));
    if (approxCols * approxRows >= fixtures) {
      cols = approxCols;
      rows = approxRows;
    }
  }

  // توزيع fixtures داخل الغرفة، ورفعها فوق الأرض (مثلاً ارتفاع 10)
  const startX = - (cols - 1) * spacingX / 2;
  const startZ = - (rows - 1) * spacingY / 2;
  for(let r = 0; r < rows; r++) {
    for(let c = 0; c < cols; c++) {
      const index = r * cols + c;
      if (index >= fixtures) break;
      const x = startX + c * spacingX;
      const y = 10; // ارتفاع الكشاف
      const z = startZ + r * spacingY;
      addFixture(x, y, z);
    }
  }

  // إعدادات التحكم بالماوس OrbitControls
  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.target.set(0, 0, 0);
  controls.update();

  // حلقة الرندر
  function animate() {
    requestAnimationFrame(animate);
    controls.update();
    renderer.render(scene, camera);
  }
  animate();

  // التكيف مع تغيير حجم النافذة
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });
</script>
</body>
</html>
