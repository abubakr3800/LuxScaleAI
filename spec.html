<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Specific Lighting Result</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">

<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-primary">Lighting Simulation - Specific Result</h2>
    <div class="d-flex gap-2">
      <button id="downloadBtn" class="btn btn-success">Download CSV</button>
      <button id="pdfBtn" class="btn btn-primary">Download PDF</button>
    </div>
  </div>
  <div id="resultsContainer" class="row g-4">
    <!-- Single result card will be injected here -->
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
<script>
const API_URL = "http://localhost/sc-luxscaleai/api/get.php"; 
const backgroundImageUrl = "assets/pdfBG.png"; 

let results = [];
let request = {};
let customer = {};

function getQueryParam(name) {
  return new URLSearchParams(window.location.search).get(name);
}

function generateCSV(data) {
  const headers = [
    "Luminaire", "Power (W)", "Efficacy (lm/W)", "Fixtures",
    "Spacing X (m)", "Spacing Y (m)", "Average Lux", "Uniformity", "Total Power (W)"
  ];
  const keys = [
    "luminaire", "power", "efficacy", "fixtures",
    "spacing_x", "spacing_y", "avg_lux", "uniformity", "total_power"
  ];
  const csv = [headers.join(",")];
  data.forEach(row => {
    csv.push(keys.map(k => `"${row[k]}"`).join(","));
  });
  return csv.join("\n");
}

function downloadCSV(csv) {
  const blob = new Blob([csv], { type: "text/csv" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  const resDate = new Date();
  link.download = `lighting_result_${resDate.toISOString().split('T')[0]}.csv`;
  link.click();
}

function displayResults(results) {
  const container = document.getElementById("resultsContainer");
  container.innerHTML = "";
  if (!results.length) {
    container.innerHTML = `<p class="text-danger">No result found.</p><img src="assets/SClogo.svg" style="width: 200px;" />`;
    return;
  }
  const result = results[0]; // always single
  const card = document.createElement("div");
  card.className = "col-md-6 col-12";
  card.innerHTML = `
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="card-title">Selected Option</h5>
        <ul class="list-group list-group-flush">
          <li class="list-group-item"><strong>Luminaire:</strong> ${result.luminaire}</li>
          <li class="list-group-item"><strong>Power (W):</strong> ${result.power}</li>
          <li class="list-group-item"><strong>Efficacy (lm/W):</strong> ${result.efficacy}</li>
          <li class="list-group-item"><strong>Fixtures:</strong> ${result.fixtures}</li>
          <li class="list-group-item"><strong>Spacing X (m):</strong> ${result.spacing_x}</li>
          <li class="list-group-item"><strong>Spacing Y (m):</strong> ${result.spacing_y}</li>
          <li class="list-group-item"><strong>Average Lux:</strong> ${result.avg_lux}</li>
          <li class="list-group-item"><strong>Uniformity:</strong> ${result.uniformity}</li>
          <li class="list-group-item"><strong>Total Power (W):</strong> ${result.total_power}</li>
          <button class="btn btn-outline-primary mt-3" onclick="goToLayout(parseInt(getQueryParam("result"), 10))">View in Layout</button>
        </ul>
      </div>
    </div>
  `;
  container.appendChild(card);
}

function goToLayout(index) {
  const result = results[index];
  const data = {
    fixtures: result.fixtures,
    spacingX: result.spacing_x,
    spacingY: result.spacing_y,
    roomLength: request.sides[0],
    roomWidth: request.sides[1]
  };
  localStorage.setItem('lightingModelData', JSON.stringify(data));
  window.location.href = 'maha/3d_model.html';
}

async function generatePDF(results, request, customer) {
  const { PDFDocument, rgb, StandardFonts } = PDFLib;
  const pdfDoc = await PDFDocument.create();
  const font = await pdfDoc.embedFont(StandardFonts.Helvetica);

  const bgImageBytes = await fetch(backgroundImageUrl).then(res => res.arrayBuffer());
  const bgImage = await pdfDoc.embedPng(bgImageBytes);

  const firstPage = pdfDoc.addPage([595.28, 841.89]); // A4
  firstPage.drawImage(bgImage, { x: 0, y: 0, width: firstPage.getWidth(), height: firstPage.getHeight() });

  let y = firstPage.getHeight() - 95;
  const marginX = 70;
  const title = "Lighting Simulation - Selected Result";
  const fontSize = 20;
  const textWidth = font.widthOfTextAtSize(title, fontSize);
  const pageWidth = firstPage.getWidth();
  const centerX = (pageWidth - textWidth) / 2;

  firstPage.drawText(title, {
    x: centerX,
    y: y,
    size: fontSize,
    font: font,
    color: rgb(0.1, 0.1, 0.1)
  });
  y -= 40;

  const customerFields = [
    ["Customer Name", customer.name],
    ["Email", customer.email],
    ["Phone", customer.phone],
    ["Company", customer.company],
    ["Project Name", request.project_name],
    ["Place", request.place],
    ["Room Size (m)", `${request.sides[0]} x ${request.sides[1]}`],
    ["Height (m)", request.height],
    ["Submitted At", request.submitted_at]
  ];
  customerFields.forEach(([label, value]) => {
    firstPage.drawText(`${label}: ${value}`, {
      x: marginX,
      y: y,
      size: 14,
      font: font,
      color: rgb(0, 0, 0)
    });
    y -= 22;
  });

  const result = results[0];
  let yPos = y - 30;
  const fields = [
    ["Luminaire", result.luminaire],
    ["Power (W)", result.power],
    ["Efficacy (lm/W)", result.efficacy],
    ["Fixtures", result.fixtures],
    ["Spacing X (m)", result.spacing_x],
    ["Spacing Y (m)", result.spacing_y],
    ["Average Lux", result.avg_lux],
    ["Uniformity", result.uniformity],
    ["Total Power (W)", result.total_power],
  ];
  fields.forEach(([label, value]) => {
    firstPage.drawText(`${label}: ${value}`, {
      x: marginX,
      y: yPos,
      size: 14,
      font: font,
      color: rgb(0, 0, 0),
    });
    yPos -= 22;
  });

  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = `lighting_result_${new Date().toISOString().split('T')[0]}.pdf`;
  link.click();
}

async function loadResults() {
  const token = getQueryParam("token");
  const resultIndex = parseInt(getQueryParam("result"), 10);

  if (!token) {
    alert("No token provided.");
    return;
  }

  try {
    const response = await fetch(`${API_URL}?token=${encodeURIComponent(token)}`);
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.message || "Failed to fetch results.");
    }

    if (data.request && data.results) {
      customer = data.customer;
      request = data.request;

      if (!isNaN(resultIndex) && data.results[resultIndex]) {
        results = [data.results[resultIndex]];
      } else {
        results = []; // no match
      }

      displayResults(results); // will show "No result found." if empty
    } else {
      results = [];
      displayResults(results);
    }

  } catch (err) {
    console.error("Fetch error:", err);
    results = [];
    displayResults(results);
  }
}



document.getElementById("downloadBtn").addEventListener("click", () => {
  const csv = generateCSV(results);
  downloadCSV(csv);
});
document.getElementById("pdfBtn").addEventListener("click", async () => {
  await generatePDF(results, request, customer);
});

loadResults();

function displayPriceRequest(request , result) {
    console.log(request);
    console.log(result);
    
//   window.location.href = "price_request.html?token=" + request.token;
}
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
